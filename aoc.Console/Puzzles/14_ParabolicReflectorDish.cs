using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace aoc.Console.Puzzles
{
    public class ParabolicReflectorDish
    {
        private const string input = @"#..O.#..#...##O..O.......O.#..#.O#.#.....#O.#.O..#OO....O..O..O.OO....O.O#.O..........#....OOO..O##O
.#O..O.O...OO..#..O...#....OO.O.........O.....#OO.#.#..O#...O..O..#..#.....##....O.#OO##O.O..#O..O.#
...O..#..OO.O#..O..#.......#...O#O..O###O.O......#.O...#O..O.#.#O.#....OO.OO.O.........OO#.#O..##..#
.O..OO.O#O....#...#O.OO....#O.#..O#O....O......##.O#.#.O#O.O.#.#........O.#......O....#.........O##.
.#..#..O.#...O..O.OO....#.#O....#O.O.....OOO#..##OO.O.O.O.##O.....O.O.....#.OO#..............#...OO.
O#O..#O.O..........#O.....O.....#..#O#...O#O.##....#...##.....##.#.#....#....O.O...O....#O..#O#.....
..#...O#..O..O#O.O...O.#OO...#.#..##OO.#O....O...O.....O..#.OO#.O.O.....O#.O.....O.##O...O.##.....O.
..O..O.OO.#.#....O.##OOO.O..O.....O.#.....#....O.#.O#..............O.#O..O..O#.O####.#..#.#.#.###...
O..#O.#.OO..........O##...O.......OO....O.....O..O..OO...O....O.#O...O#O#.......OO...#....O.#.......
......##.....OO...#..#O#........#.#.O.O.#..#.#..#....#.....OO#O#....##O.OOO......#....O.......O.....
..O...#.....#...#.OO...#O....#..O.##....O.#.O....O...O..O.#....O#..#.....##..O..O....O..#OO..O......
.O.....OO.....#.O#...O#........#..O...O#...O..OO..O##...O#O.O.O#.......#...O.O..##..O.OO...#.....O..
.....O.#O####..O#O........OO...##O..#..#..O....OO..O.#.O.......O#...#.#...OOO#.OO.O.......#O.OOO.##.
..#.#O#.........O.O...O.O.#..O#.#.O...O.#.O.O.#...O#......#......O.OO...#......O#.#O.#.OO#...O.O.O..
#......#..O....O...O.O#...O.O......#O#.#.....#.....##OOO.........#........O..O.O...O#.........OO.#OO
.#.O....##...O#O..................O.#O.........O.#..O.#..O...#O#..#..O...O...O.O.OO.#...OO#OO.##....
OO..O..O....#..#O...#..#..........##O#O.##..#.O....#.OO.O##.#......O#...O.#O...OOO.O.#.O....O.#.O...
#.O.#.......O...#....#...O..O.OO..O.#.#.##O.O.#OO....OO.......O.......O....O.O.OO...#.#......#....O.
O....O.O#.O..##..#..#..........OO......O.O.....O...#.#...#.OO.O.....#..O.O...#....OO.#......#...O...
OO..#..O..........#..O.O...O.OOO.OO...#...OO.....O.O.OO##.O..O..#..#.O.#.##.O..........O......O...O.
....O.O..O.....##..#.O..#.#.....O.O.O....O#.#.....OO..O....#...........O..OO##.....O.##..##O...#..O#
..O.O#.O......O.....OO.OOOOO..#...O#O...#O##....#..#.....O#O............O.O....O#O......O..####O.O#O
#..O.O............###.O..#....O.#...#.O#..O.OOOO....O..#.#.#.O...#.OOO.#.O..O.#...O#.O..O....#..OO..
#O...O.#..O#OO#..O......#.##O......OO.O...O.OOO#O#....OO.#O.O##.....O.#..###..O#...O......OOOO.O.O.O
..#..O..O.OO...#..#.#..#..O#.O#O...OOOO##...#..#...#.O....OO......#O.O....O....#.O..O..O.......OO...
.......O..OO...O..O...O...O#.OO#.#.#...#OO.......##.OO..#....OO...O....#O.....#.O.OO.O.O#...#.#.#...
.#O##..O..OO.#O.O...OO......O.#...O#.O....#........#O.#.....#..O.#.###.O#.O.#O....O...O....#...O.O.O
...##.#....O##...O.#O#.O.#..#..#.....OO..#.OO....#O.#.....#.....##..OO..#O.....OO.OO....#..OO#.O.##.
O...#O#..O..##O.........O##....O.#.............#.O#.....#.O..#...O...#.O.......#..#.OO...O...#..O..#
O.#.OO.....##..##....OO.#...#...O..O#..#..#.O#...O#..#..O.#OO#.O.....O.OOO....O.O.......#...OO..##..
..#.###..O.O.O..O...O..##..O#.O..O....O..#..#.#..O..#...##.O#.....##....#O.#O.OO..O..O#..O#..O......
.###..#..#O.O##..OOO..OO#.O#...#O....#.....O......OO.O.OO#.OOO...#......O.#....O.O..OOO.....#O...#.O
..O..#...O.....OOO.O.O#......#.......OO...#..O..O.O#..#.O.O..OO#..OOO.O...#...#OO..O.OOO.OOO##......
OO#.O..#..OOOOO..##.......#OO....#O..#.O...O..#..#.##....O.#OO.#..####O.......O...........#.O#......
..........O#..O....#..#......O..OO...............O.##OOO#O..O....#......#..#..O..O.O..#.O.#....O.#.O
.#O.OO..#.O.#....#....###...O.....##..#...O.O#O..##....OOO.#..##...O...#....O##...#O...O....O..O..O.
#.....O....O#.#........#O..#..#O.O........#.#....OO#..O.O..OOO#..O..........OOO.O...O....#.#..OO##..
..O...OOO....##..##...O#.O..O#.#....O#...O...#.O..O.O...OOO...OO...#O.#..O.#.....#........O#O...O##.
O.O...#.O.O..#O..O...O.......O#.O.......#.OO###.##.O#....#.....#.....#O.........##..#....OO..O...O#O
.O..OO.#O...#..#.....#.O..O.#.......OO......O...OO.O....O.O.....O...#O.....#......O#.#####.O.O...O.O
#O.....O.......O....#...O.O.OO.#.#O.OO......#OO..O.#.......#...O.#.#.OO..#.O..#.#...#..O......OO..O.
...#O#...#..#OO....#.........O.#.O.....O#....##.O.#....#...#...#....#..#.OO......O.O..##.#......OO..
O........O.....#.O..O............OOO..##....O#OO..O#...#....#.#.OO#O.O.O#...##.#..OO...#O...O.O...#.
.........##.#..O..#...OO.O#..O..#..#...O.O.O.OOO.O...O#..#O.#......O.#O...O.O..#......O...##.O.O..O.
O..O..#..O...#.#OO...........O.....O....#...#.O.......#..#O.......O#.......#......#..O..O.#....O#.O.
....O.O..O.O.O..#.#..O##..#..O.#..O..#.###O#..#O..O...O....O..OO.#..#OO#O..O......#....O.O.....#O...
#.........#.#....#..##OOO.......##O..O..O..O.O.#O..#.O#..O.#O..O#..#O..##O...O.O.O.#O..#.O#O...#.O.O
......O....O..O#..OO#..OO..#...O....O.....O..#..#.O..##.O......#..#O..#O...#.......O...#.#..OO...O..
.#....O#...............#.....#.O#..#O...#...#.O...O.#..O##..O#...O..........OOOO..O.#..O...O..#.....
..#O#..O.OO.O...O#.O......##.##O.......O..O.#....O.O#O##.#..OO.#....OO.O..OO...#.O.O.....#.##.###.O.
.##.O.OO.OO.....#O....##OO...O.#O.#...##.O....O##...O#.#....#.....O...OO.OO..#OO.....#OO........#..#
.#O.O...#O.##.O.##OO.#O#..#...#.#.O#.OO#.O.O.O#..#....O#OO....##...#.O.O#.O....O..#..#.OO.....#..#..
....O#....#OOO.O.O..#O..#O.O..#.......O#..#....O...OO...O..O..##O...#.O....O..O.O.#...##.OO#O....#.#
OO.......O.#..#....OO..O#.#.OO...#.#.#.O.....##.....OO.#...#....###O#..............O...O........O...
.O.#....O....O........O#.....#.....O.O#..#..OO.......O....#....#O.#.O...OO..##.O.........OO.##..##..
.#..#..OO.##......##...#O#.O.O.O.#..O#..O........O.....#.##...O...##O..O.OO.O.#.OO......O.O..#..##O.
#O.O...O......##O.##OO....##....#O.O.OO.#.O.....O#.##...#.....O..#..O...O......O#O..O#O...#..O......
.O....#..OO..........#.O##.#.O.#.#O....O..#..O...O.#OO..#.....O......#....##......#..O....#...O...O#
OO.#.OOO.#OOO#.##...#.O.O.#O#..O...#....OO.O...OOOO....#.O....O...O.......#.#O.##OO..O..#OO.......OO
#.#.#........#....#..O..O.#..#.O#OO.#......#..###..O.O....O.OO#...#.O.#..#..O.....#...............OO
.#.O..OO#O##..#..#...##O.O....#.OO..O.OOO.#O#..OOO.O.......##O...OO...O..........#O.O..#..OO#..#....
O.#...#..#...#O#..O.OO..#.#.O..OO......O.#..#O...#...OO...#.#...OO..#..#....#....##OO.........O.....
..##.....#O.#O.O.O..#...#..#O#.....O..O....O......O#..#O...O#.#.....O.#O..OO..#.O.....#.......O.....
.#.#..O.O.OOOOOO...##.........##O.##O#.O#O..#.....O.O.O..#..O#.O.O#............#O.......#.....#O.#..
...O......O.O..O.#..OO.O##O...###O#.O..O#O#..O.#.#.......#OO..O....O.....#.#.OO#....O.O.OO...O.#.OO.
.#...O..O#......O...O.O....O..O...#.OO.........O.....O#..O.....O...#..O##O.O.O.....O.#.....O##..OO..
##.#....O.O.....OO.O......O.O...O.#OO.O.O.O..O#...O.O..OOO.O#.#.#.###.....OO#OO..#..O.O#..O...O.....
..O.#..#.....O.#..#..#....OO#O.O.O#......##.#.O.#.##.O..#.O...........O.#....O#....OO......#...#.O#.
...O..O...O.......#....#...#.O.#....#O#.....O....O...O#.....#..#.#O.#.#...#..##....#....#...O..O#...
OO.....#.......#O#.O##OO.#.#.O.OO#O..#.#..#O#.O.....O..##O.....#O.##O..#..###...O....O...OO...#.O#..
...#.O##.....#.....OO...O...OO...O...##..O.....#.#..OO...O##....O.O...O#.....#.#..O..O.....O#.#.#..O
.#O..O.....O...#......O#...O.....#O#.O......####O......#O...O.O#......##O#O##O..OOO###.O.........O.#
..O.....O#...#O.#OO.......OO..#...#.O.#.O....O..#.....O.O..O..OO.#O..#.O..##..O.O.......O..#O#..#...
...O#....#.......OO#.##..#.....#..O.....#..##...##..OO#..#.......#.O#O.......O.#..#.O..O..O...O..#..
O.#..#.O...........#....OO.O.#O..O.O......#..O....##O.O..O...OOO#..O..OO...OO#.#.O.OO.O#.OO...OO.#..
O#O#..O..O#.O...#..O...##O.#.#.O#.O..........O.O#..O...##...#.O.........#.##...#..OO....#O........O.
...#.O.O....#.........O.OO..#.#OO...O.O#..#.......#..#.O.#.....O..O.#O..OOO..O.##........##.#OO...#.
#...OOO....OO.O.O#O....#O....O.#.O.O...#....##.##OO...#.O..O.O....O#...O#.O...O#OO.O#......OOO#.O...
..#.#O#.O.O.#O............#.#...O.......O#..OO.O.#..O.O.O..O...O#...#....#...##O.O.#...#...#.#.O..O.
..#O..O.O...OO..OOO.....#O.O........#.O#....#....O.O#.O.O.#.#OO..O.#............O.O....#.......O....
O#.O.OO.O.#...#..O#.#...#.O#.O...O.O..O....##.O.#O.........OO.O#...O...##.OO...##.O..O#O...#O.#..#.#
..#.O....O...O..O....#O...#.#.O....#.#.O.#....##........#...#..##...O.OOO#.O.O..O#.#.O.....O...OO..#
..#.....O.O.#OO.#.O.......O.O......O#.#...#..##.O....#.O..#.O..#..O#..#...O...#......OO.#...OO...#..
....##..O....#...#......#O.#.#OOOO......O....#.#O........#....#....#.##.........#..O..#.#O...OO##...
O#..O..O...#.O..OO#.O.O...O.##..O..#...O.#O..O...#.O#O#.#.#...O..O#O.....O.O#O.....#O.#..........#..
..O....###...O#..O..O..O....O..OO...O.O..###.#......O##...O..#..#........O...O.O.OO..##.....O#..#.#.
.#.#.......O#....#.OO#..#.O..O.............O#...##.O...O#.O#O.#..#.#.###..#..#.#OO.OO#..#..#O#.O....
...#O..O..O.O..O..#...OO..O.OO#...#.O#.O..#...O..........##..O........O.O....O..O.......#..#...OOOO.
O....O......O.....##.#...O.#..O......#..O#.O#O..OO##....#......##..O.#..#.O##O.....##OO.........O...
O.##....OO....OO..O...O..O...O...O...OO.OO###O..#.#..#O#..O.O.#.....O...O....OO.O..O..#O..#O....OO..
...#O..#.......O##.#.......#......#.O..O....O...#...##.O#.OOO##..#..O.#..O.O.O#..OO...#....#O.O...O.
...O.O.O........#.O#..#OOO..O...O.....O.....OO..O.#...O#.......O.....OO.O..#.....O.....O#...O.O.....
...#..OO...#..O...#...O..O#O..O........OO.#..#O#..OO..O......####....#..#..#...#...OO.#.OO.OO.#....O
O##....#...OO..O..##O.O..OO.#...O.O#...O....#.....#......#.#.O#...#O.O....O#.##.O..#...O.#.O#.##..#.
OO...O..OO.O.#O.........#OO.O.#.O..O..O..O#..#.#OO.OO..O...OO#...##...O.......##...O.O#..#...#....OO
.O.O.#.O.O...OOO.#.#...#..O...OO..O....#.......OO.#......O.......#...#....#.O...O#O.........OO.O....
........#.#....#....O.#....O#OO..OO...OO....#...O....O.OOOO....#......#.O..O#####.OO..#..O##.......#
.O....#OO#.O#O.OO.#...#.#..O..O..###...OO.#..........O#O...#.....O..O#OO.#.O.OO..O.#..#.O#.#.#....#.
..O#.O.....O.O#OO..##...OO.#.#...OO..OO#.O.#OO#.OO.#.....O.O.O..O.....O#......O#...OO..#...O...#.#..
O..OO....O#.O.#O...#O..OOO.O...OOO.O..##..O..O...O#..#.OO...O....O.......#......OO.....OOO...#O.O##.";

        public static int GetTotalWeight(int cycles = 0, string? dish = null)
        {
            dish ??= input;

            var tilted = 
                cycles > 0 ? 
                Cycle(dish.Split(Environment.NewLine), cycles) :
                TiltLever(dish.Split(Environment.NewLine));
            var result = 0;
            var weight = tilted.Length;
            for (var i = 0; i < tilted.Length; i++)
            {
                result += CalculateRowWeight(tilted[i], weight--);
            }

            return result;
        }

        public static string[] TiltLever(string[] dish)
        {
            foreach (var _ in dish)
            {
                for (var i = dish.Length - 1; i >= 1; i--)
                {
                    var updated = MoveNorth(dish[i - 1], dish[i]);
                    dish[i] = updated[1];
                    dish[i - 1] = updated[0];
                }
            }

            return dish;
        }

        public static string[] MoveNorth(string northRow, string southRow)
        {
            char[] resultNorth = northRow.ToCharArray()!;
            var resultSouth = southRow.ToCharArray()!;

            for (var index = 0; index < northRow.Length; index++)
            {
                if (northRow[index] == '.' && southRow[index] == 'O')
                {
                    resultNorth[index] = southRow[index];
                    resultSouth[index] = '.';
                }
                else
                {
                    resultNorth[index] = northRow[index];
                    resultSouth[index] = southRow[index];

                }
            }

            return [
                new string(resultNorth),
                new string(resultSouth)
                ];
        }

        public static int CalculateRowWeight(string line, int weight)
        {
            return line.ToCharArray()
                .Where(@char => @char == 'O').Count() * weight;
        }

        public static string[] Cycle(string[] dish, int numberOfCycles)
        {
            System.Console.Write($"\rRemaining cycles #{numberOfCycles}            ");
            if (numberOfCycles == 0)
            {
                return dish;
            }

            string[] resultAfter4Cycles = dish;
                var watch = new Stopwatch();
                watch.Start();
            for (var internalCycle = 1; internalCycle <= 4; internalCycle++)
            {
                var tilted = TiltLever(resultAfter4Cycles);

                if (internalCycle <= 4)
                {
                    var turned = new string[tilted.Length];
                    var col = 0;
                    for (var i = 0; i < tilted.Length; i++)
                    {
                        turned[i] = new string(tilted.Reverse().Select(line => line[col]).ToArray());
                        col++;
                    }
                    resultAfter4Cycles = turned;
                }
                else
                {
                    resultAfter4Cycles = tilted;
                }

            }
                watch.Stop();
                Debug.WriteLine($"cycle time: {watch.Elapsed}");

            return Cycle(resultAfter4Cycles, --numberOfCycles);
        }
    }
}
